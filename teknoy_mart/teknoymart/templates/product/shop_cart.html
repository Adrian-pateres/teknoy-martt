{% extends "teknoymart/base.html" %}
{% load static %}

{% block title %}Shopping Cart | Teknoy Mart{% endblock %}

{% block content %}
<div class="shop-cart-container">
  <!-- Main Content Area -->
  <div class="cart-main">
    <!-- Shop Section -->
    <section class="shop-section">
      <div class="section-header">
        <h2 class="section-title">Shop</h2>
        <a href="{% url 'home' %}" class="back-link">‚Üê Back to Shop</a>
      </div>

      <!-- Category Filters -->
      <div class="category-filters">
        <button class="category-btn active">All</button>
        <button class="category-btn">Clothing</button>
        <button class="category-btn">Electronics</button>
        <button class="category-btn">Food</button>
        <button class="category-btn">Accessories</button>
      </div>

      <!-- Latest Products Preview -->
      <div class="products-preview">
        <h3>üõí Continue Shopping</h3>
        <a href="{% url 'home' %}" class="view-all-link">View all</a>
      </div>
    </section>

    <!-- Categories Sidebar -->
    <aside class="categories-sidebar">
      <h3 class="sidebar-title">Categories</h3>
      <ul class="category-list">
        <li class="category-item active">
          <span class="category-icon">üëï</span>
          <span>Clothing</span>
        </li>
        <li class="category-item">
          <span class="category-icon">üíª</span>
          <span>Electronics</span>
        </li>
        <li class="category-item">
          <span class="category-icon">üçî</span>
          <span>Food</span>
        </li>
        <li class="category-item">
          <span class="category-icon">üëú</span>
          <span>Accessories</span>
        </li>
      </ul>
    </aside>
  </div>

  <!-- Shopping Cart Section -->
  <div class="shopping-cart-section">
    <div class="cart-header">
      <h2>üõçÔ∏è Shopping Cart</h2>
      <span class="cart-count">{{ cart.total_items }} item{{ cart.total_items|pluralize }}</span>
    </div>

    {% if cart_items %}
    <!-- Cart Items -->
    <div class="cart-items">
      {% for item in cart_items %}
      <div class="cart-item" data-item-id="{{ item.id }}">
        <input type="checkbox" class="item-checkbox" checked>
        <div class="item-image">
          {% if item.product.image %}
            <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
          {% else %}
            <img src="https://via.placeholder.com/100?text=No+Image" alt="{{ item.product.name }}">
          {% endif %}
        </div>
        <div class="item-details">
          <h4 class="item-name">{{ item.product.name }}</h4>
          <p class="item-category">{{ item.product.category }}</p>
          <p class="item-seller">Sold by: {{ item.product.seller.username }}</p>
        </div>
        <div class="item-price">
          <span class="price" data-price="{{ item.product.price }}">‚Ç±{{ item.product.price|floatformat:2 }}</span>
        </div>
        <div class="item-quantity">
          <button class="qty-btn minus" data-action="decrease">‚àí</button>
          <input type="number" class="qty-input" value="{{ item.quantity }}" min="1" max="{{ item.product.quantity }}" readonly>
          <button class="qty-btn plus" data-action="increase">+</button>
        </div>
        <div class="item-total">
          <span class="total-price">‚Ç±{{ item.total_price|floatformat:2 }}</span>
        </div>
        <button class="item-remove" data-item-id="{{ item.id }}">üóëÔ∏è</button>
      </div>
      {% endfor %}
    </div>

    <!-- Cart Actions -->
    <div class="cart-actions">
      <div class="select-all">
        <input type="checkbox" id="selectAll" checked>
        <label for="selectAll">Select All ({{ cart_items|length }})</label>
      </div>
      <button class="delete-selected">Delete Selected</button>
    </div>

    <!-- Cart Summary -->
    <div class="cart-summary">
      <div class="summary-row">
        <span>Subtotal (<span id="selected-count">{{ cart_items|length }}</span> items):</span>
        <span class="summary-value" id="subtotal-value">‚Ç±{{ cart.subtotal|floatformat:2 }}</span>
      </div>
      <div class="summary-row">
        <span>Shipping Fee:</span>
        <span class="summary-value">‚Ç±{{ cart.shipping_fee|floatformat:2 }}</span>
      </div>
      <div class="summary-row total">
        <span>Total:</span>
        <span class="summary-total" id="total-value">‚Ç±{{ cart.total|floatformat:2 }}</span>
      </div>
      <button class="checkout-btn">Proceed to Checkout</button>
    </div>
    {% else %}
    <!-- Empty Cart Message -->
    <div class="empty-cart">
      <div class="empty-cart-icon">üõí</div>
      <h3>Your cart is empty</h3>
      <p>Add items to your cart to get started!</p>
      <a href="{% url 'home' %}" class="continue-shopping-btn">Continue Shopping</a>
    </div>
    {% endif %}
  </div>
</div>

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background: #f5f5f5;
  }

  .shop-cart-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    display: grid;
    grid-template-columns: 1fr 450px;
    gap: 20px;
  }

  /* Main Content Area */
  .cart-main {
    display: flex;
    gap: 20px;
  }

  /* Shop Section */
  .shop-section {
    flex: 1;
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #8B0000;
  }

  .section-title {
    font-size: 1.8rem;
    color: #8B0000;
    font-weight: 700;
  }

  .back-link {
    color: #666;
    text-decoration: none;
    font-size: 0.95rem;
    transition: color 0.3s;
  }

  .back-link:hover {
    color: #8B0000;
  }

  /* Category Filters */
  .category-filters {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 30px;
  }

  .category-btn {
    padding: 10px 24px;
    border: 2px solid #e0e0e0;
    background: white;
    border-radius: 50px;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 500;
    transition: all 0.3s;
  }

  .category-btn.active {
    background: #8B0000;
    color: white;
    border-color: #8B0000;
  }

  .category-btn:hover:not(.active) {
    border-color: #8B0000;
    color: #8B0000;
  }

  /* Products Preview */
  .products-preview {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 30px;
  }

  .products-preview h3 {
    font-size: 1.2rem;
    color: #333;
  }

  .view-all-link {
    color: #8B0000;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.95rem;
  }

  .view-all-link:hover {
    text-decoration: underline;
  }

  /* Categories Sidebar */
  .categories-sidebar {
    width: 250px;
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    height: fit-content;
  }

  .sidebar-title {
    font-size: 1.3rem;
    color: #333;
    margin-bottom: 20px;
    font-weight: 700;
  }

  .category-list {
    list-style: none;
  }

  .category-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: 8px;
  }

  .category-item:hover {
    background: #fff4f4;
  }

  .category-item.active {
    background: linear-gradient(135deg, #fff4f4 0%, #ffecec 100%);
    font-weight: 600;
  }

  .category-icon {
    font-size: 1.5rem;
  }

  /* Shopping Cart Section */
  .shopping-cart-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    height: fit-content;
    position: sticky;
    top: 20px;
  }

  .cart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f0f0f0;
  }

  .cart-header h2 {
    font-size: 1.5rem;
    color: #333;
  }

  .cart-count {
    background: #8B0000;
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
  }

  /* Cart Items */
  .cart-items {
    max-height: 500px;
    overflow-y: auto;
    margin-bottom: 20px;
  }

  .cart-item {
    display: grid;
    grid-template-columns: 30px 80px 1fr 80px 120px 80px 30px;
    gap: 12px;
    align-items: center;
    padding: 15px;
    border: 1px solid #f0f0f0;
    border-radius: 8px;
    margin-bottom: 12px;
    transition: all 0.3s;
  }

  .cart-item:hover {
    border-color: #8B0000;
    box-shadow: 0 2px 8px rgba(139, 0, 0, 0.1);
  }

  .item-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #8B0000;
  }

  .item-image {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #f0f0f0;
  }

  .item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .item-details {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .item-name {
    font-size: 0.95rem;
    font-weight: 600;
    color: #333;
    line-height: 1.3;
  }

  .item-category {
    font-size: 0.8rem;
    color: #8B0000;
    font-weight: 500;
  }

  .item-seller {
    font-size: 0.75rem;
    color: #999;
  }

  .item-price .price {
    font-size: 0.95rem;
    font-weight: 600;
    color: #333;
  }

  /* Quantity Controls */
  .item-quantity {
    display: flex;
    align-items: center;
    gap: 8px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    padding: 4px;
  }

  .qty-btn {
    width: 28px;
    height: 28px;
    border: none;
    background: #f5f5f5;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
  }

  .qty-btn:hover {
    background: #8B0000;
    color: white;
  }

  .qty-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .qty-input {
    width: 40px;
    border: none;
    text-align: center;
    font-weight: 600;
    font-size: 0.95rem;
    background: transparent;
  }

  .qty-input::-webkit-outer-spin-button,
  .qty-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .item-total .total-price {
    font-size: 1rem;
    font-weight: 700;
    color: #8B0000;
  }

  .item-remove {
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    opacity: 0.6;
    transition: all 0.3s;
  }

  .item-remove:hover {
    opacity: 1;
    transform: scale(1.2);
  }

  /* Cart Actions */
  .cart-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: #f9f9f9;
    border-radius: 8px;
    margin-bottom: 20px;
  }

  .select-all {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .select-all input {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #8B0000;
  }

  .select-all label {
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
  }

  .delete-selected {
    background: none;
    border: 1px solid #ff4d4d;
    color: #ff4d4d;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.3s;
  }

  .delete-selected:hover {
    background: #ff4d4d;
    color: white;
  }

  /* Cart Summary */
  .cart-summary {
    border-top: 2px solid #f0f0f0;
    padding-top: 20px;
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    font-size: 0.95rem;
  }

  .summary-row.total {
    font-size: 1.1rem;
    font-weight: 700;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #f0f0f0;
  }

  .summary-value {
    font-weight: 600;
  }

  .summary-total {
    color: #8B0000;
    font-size: 1.3rem;
  }

  .checkout-btn {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, #8B0000 0%, #a40000 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    margin-top: 20px;
    transition: all 0.3s;
    box-shadow: 0 4px 12px rgba(139, 0, 0, 0.3);
  }

  .checkout-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(139, 0, 0, 0.4);
  }

  /* Empty Cart */
  .empty-cart {
    text-align: center;
    padding: 60px 20px;
  }

  .empty-cart-icon {
    font-size: 5rem;
    margin-bottom: 20px;
    opacity: 0.5;
  }

  .empty-cart h3 {
    font-size: 1.5rem;
    color: #333;
    margin-bottom: 10px;
  }

  .empty-cart p {
    color: #666;
    margin-bottom: 30px;
  }

  .continue-shopping-btn {
    display: inline-block;
    padding: 12px 30px;
    background: #8B0000;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s;
  }

  .continue-shopping-btn:hover {
    background: #a40000;
    transform: translateY(-2px);
  }

  /* Responsive Design */
  @media (max-width: 1200px) {
    .shop-cart-container {
      grid-template-columns: 1fr;
    }

    .shopping-cart-section {
      position: static;
    }
  }

  @media (max-width: 768px) {
    .cart-main {
      flex-direction: column;
    }

    .categories-sidebar {
      width: 100%;
    }

    .cart-item {
      grid-template-columns: 30px 60px 1fr;
      gap: 10px;
    }

    .item-price,
    .item-quantity,
    .item-total {
      grid-column: 2 / -1;
      justify-self: start;
    }

    .item-remove {
      grid-column: -2;
      grid-row: 1;
    }
  }
</style>

<script>
  // CSRF Token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // Show toast notification
  function showToast(message, type = 'success') {
    // Simple alert for now, can be replaced with toast library
    alert(message);
  }

  // Update quantity
  document.querySelectorAll('.qty-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const cartItem = this.closest('.cart-item');
      const itemId = cartItem.dataset.itemId;
      const input = cartItem.querySelector('.qty-input');
      const currentVal = parseInt(input.value);
      const maxVal = parseInt(input.max);
      
      let newVal = currentVal;
      if (this.dataset.action === 'increase' && currentVal < maxVal) {
        newVal = currentVal + 1;
      } else if (this.dataset.action === 'decrease' && currentVal > 1) {
        newVal = currentVal - 1;
      } else {
        return;
      }
      
      // Update via AJAX
      fetch(`/cart/update/${itemId}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ quantity: newVal })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          input.value = newVal;
          cartItem.querySelector('.total-price').textContent = `‚Ç±${data.item_total.toFixed(2)}`;
          document.getElementById('subtotal-value').textContent = `‚Ç±${data.cart_subtotal.toFixed(2)}`;
          document.getElementById('total-value').textContent = `‚Ç±${data.cart_total.toFixed(2)}`;
        } else {
          showToast(data.message, 'error');
        }
      });
    });
  });

  // Remove item
  document.querySelectorAll('.item-remove').forEach(btn => {
    btn.addEventListener('click', function() {
      if (!confirm('Remove this item from cart?')) return;
      
      const cartItem = this.closest('.cart-item');
      const itemId = this.dataset.itemId;
      
      fetch(`/cart/remove/${itemId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          cartItem.remove();
          document.querySelector('.cart-count').textContent = `${data.cart_count} items`;
          document.getElementById('subtotal-value').textContent = `‚Ç±${data.cart_subtotal.toFixed(2)}`;
          document.getElementById('total-value').textContent = `‚Ç±${data.cart_total.toFixed(2)}`;
          showToast(data.message);
          
          // Reload if no items left
          if (data.cart_count === 0) {
            location.reload();
          }
        } else {
          showToast(data.message, 'error');
        }
      });
    });
  });

  // Select all checkbox
  document.getElementById('selectAll')?.addEventListener('change', function() {
    document.querySelectorAll('.item-checkbox').forEach(cb => {
      cb.checked = this.checked;
    });
  });

  // Checkout button
  document.querySelector('.checkout-btn')?.addEventListener('click', function() {
    const checkedItems = document.querySelectorAll('.item-checkbox:checked');
    if (checkedItems.length === 0) {
      showToast('Please select items to checkout', 'error');
      return;
    }
    alert('Proceeding to checkout...');
    // Redirect to checkout page
    // window.location.href = '/checkout/';
  });

  // Notification Toggle
  const notificationBell = document.getElementById('notificationBell');
  const notificationDropdown = document.getElementById('notificationDropdown');
  const notificationBadge = document.getElementById('notificationBadge');
  const markAllReadBtn = document.getElementById('markAllRead');

  // Toggle notification dropdown
  notificationBell?.addEventListener('click', function(e) {
    e.stopPropagation();
    notificationDropdown.classList.toggle('show');
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    if (!notificationDropdown?.contains(e.target) && e.target !== notificationBell) {
      notificationDropdown?.classList.remove('show');
    }
  });

  // Mark single notification as read
  document.querySelectorAll('.notification-item').forEach(item => {
    item.addEventListener('click', function() {
      const notificationId = this.dataset.id;
      
      if (this.classList.contains('unread')) {
        // Send AJAX request to mark as read
        fetch(`/notifications/mark-read/${notificationId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            this.classList.remove('unread');
            updateNotificationBadge();
          }
        });
      }
    });
  });

  // Mark all as read
  markAllReadBtn?.addEventListener('click', function() {
    fetch('/notifications/mark-all-read/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.querySelectorAll('.notification-item.unread').forEach(item => {
          item.classList.remove('unread');
        });
        notificationBadge.classList.add('hidden');
      }
    });
  });

  // Update notification badge count
  function updateNotificationBadge() {
    const unreadCount = document.querySelectorAll('.notification-item.unread').length;
    if (unreadCount > 0) {
      notificationBadge.textContent = unreadCount;
      notificationBadge.classList.remove('hidden');
    } else {
      notificationBadge.classList.add('hidden');
    }
  }

  // Initialize badge count
  updateNotificationBadge();

  // Real-time notification polling (optional)
  setInterval(function() {
    fetch('/notifications/get-new/')
      .then(response => response.json())
      .then(data => {
        if (data.has_new) {
          // Update notification list
          updateNotificationBadge();
          // Optionally show a toast
        }
      });
  }, 30000); // Check every 30 seconds
</script>
{% endblock %}
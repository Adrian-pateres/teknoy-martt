{% extends "teknoymart/base.html" %}
{% load static %}

{% block title %}Home | Teknoy Mart{% endblock %}
{% block body_class %}home-page{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
{% endblock %}

{% block navbar %}
<header class="navbar">
  <div class="logo-text">
    <img src="{% static 'images/logo.png' %}" alt="Teknoy Mart Logo" class="navbar-logo">
    <span>Teknoy Mart</span>
  </div>
  <nav class="top-actions">
  <div class="nav-item dropdown" id="notifDropdown">
  <a href="javascript:void(0)" class="nav-link notif-toggle" onclick="toggleNotifMenu()">
    <span class="icon">üîî</span>
    <span id="notif-badge" class="badge-count" style="display:none;">0</span>
  </a>

  <div class="dropdown-menu-right" id="notifMenu">
    <div class="dropdown-header">
      <span>Notifications</span>
      <a href="{% url 'notifications' %}" class="view-all-link">View All</a>
    </div>
    
    <div id="notif-items-list">
      <div class="loading-spinner">Loading...</div>
    </div>
  </div>
</div>

<style>
  .nav-item.dropdown { position: relative; display: inline-block; margin-right: 15px; }
  
  .notif-toggle { 
    position: relative; 
    text-decoration: none; 
    font-size: 1.2rem; 
    cursor: pointer;
  }

  /* Red Badge */
  .badge-count {
    position: absolute;
    top: -5px;
    right: -8px;
    background-color: #ff3b30;
    color: white;
    font-size: 0.7rem;
    font-weight: bold;
    padding: 2px 5px;
    border-radius: 10px;
    min-width: 15px;
    text-align: center;
    border: 2px solid white;
  }

  /* Dropdown Box */
  .dropdown-menu-right {
    display: none; /* Hidden by default */
    position: absolute;
    right: 0;
    top: 100%;
    width: 320px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    z-index: 1000;
    overflow: hidden;
    margin-top: 10px;
    border: 1px solid #eee;
  }

  /* Header */
  .dropdown-header {
    background: #f8f9fa;
    padding: 10px 15px;
    font-weight: bold;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    font-size: 0.9rem;
    color: #333;
  }
  .view-all-link { color: #8B0000; text-decoration: none; font-size: 0.8rem; }

  /* List Items */
  .notif-item {
    display: flex;
    gap: 10px;
    padding: 12px 15px;
    border-bottom: 1px solid #f0f0f0;
    text-decoration: none;
    color: #333;
    transition: background 0.2s;
  }
  .notif-item:hover { background: #fdfdfd; }
  .notif-item.unread { background: #fff5f5; } /* Light red for unread */
  
  .notif-icon-small { font-size: 1.2rem; }
  .notif-text { flex: 1; font-size: 0.85rem; line-height: 1.3; }
  .notif-title { display: block; font-weight: 700; margin-bottom: 2px; }
  .notif-time { display: block; font-size: 0.7rem; color: #999; margin-top: 4px; }

  .empty-msg { padding: 20px; text-align: center; color: #999; font-size: 0.9rem; }
  .loading-spinner { padding: 20px; text-align: center; color: #ccc; }

  /* Dark Mode Support */
  body.dark-mode .dropdown-menu-right { background: #1e1e1e; border-color: #333; }
  body.dark-mode .dropdown-header { background: #252525; border-color: #333; color: white; }
  body.dark-mode .notif-item { color: #e0e0e0; border-color: #333; }
  body.dark-mode .notif-item:hover { background: #2d2d2d; }
  body.dark-mode .notif-item.unread { background: #330000; }
</style>

<script>
  function toggleNotifMenu() {
    const menu = document.getElementById('notifMenu');
    if (menu.style.display === 'block') {
      menu.style.display = 'none';
    } else {
      menu.style.display = 'block';
      fetchNotifications(); // Refresh when opening
    }
  }

  // Close dropdown if clicking outside
  document.addEventListener('click', function(e) {
    const container = document.getElementById('notifDropdown');
    const menu = document.getElementById('notifMenu');
    if (!container.contains(e.target)) {
      menu.style.display = 'none';
    }
  });

  function fetchNotifications() {
    fetch("{% url 'api_notifications' %}")
      .then(res => res.json())
      .then(data => {
        // 1. Update Badge
        const badge = document.getElementById('notif-badge');
        badge.innerText = data.count;
        if (data.count > 0) {
          badge.style.display = 'block';
        } else {
          badge.style.display = 'none';
        }

        // 2. Build List
        const listContainer = document.getElementById('notif-items-list');
        listContainer.innerHTML = ''; // Clear loading

        if (data.notifications.length === 0) {
          listContainer.innerHTML = '<div class="empty-msg">No notifications</div>';
          return;
        }

        data.notifications.forEach(notif => {
          let icon = 'üì¢';
          if (notif.type === 'order') icon = 'üì¶';
          if (notif.type === 'message') icon = 'üí¨';

          const unreadClass = notif.read ? '' : 'unread';

          const html = `
            <a href="${notif.link}" class="notif-item ${unreadClass}">
              <div class="notif-icon-small">${icon}</div>
              <div class="notif-text">
                <span class="notif-title">${notif.title}</span>
                ${notif.message}
                <span class="notif-time">${notif.time}</span>
              </div>
            </a>
          `;
          listContainer.innerHTML += html;
        });
      });
  }

  // Initial fetch on page load
  document.addEventListener('DOMContentLoaded', fetchNotifications);
  
  // Poll every 30 seconds for new alerts
  setInterval(fetchNotifications, 30000);
</script>
  <a href="{% url 'profile' %}">Profile</a>

  <!-- Hamburger menu -->
  <div class="menu-wrap">
    <button id="hamburgerBtn" class="hamburger" aria-haspopup="true" aria-expanded="false">
    <span></span><span></span><span></span>
    </button>

    <div id="userMenu" class="dropdown-menu" role="menu">
      <a role="menuitem" href="{% url 'inbox' %}">üí¨ Messages</a>
      <a role="menuitem" href="{% url 'settings_about' %}">About</a>
      <a role="menuitem" href="{% url 'preferences' %}">Preferences</a>
      <a role="menuitem" href="{% url 'privacy_settings' %}">Privacy</a>
      <a role="menuitem" href="{% url 'transaction_history' %}">Transaction History</a>

      <button role="menuitem" type="button" id="menu-dark" class="menu-item-btn">
        üåô Dark Mode
      </button>

      <a role="menuitem" href="{% url 'terms' %}">Terms</a>
      <a href="{% url 'delete_account' %}">Delete Account</a>
      
      <a href="{% url 'logout_confirm' %}">Logout</a>
    </div>
  </div>
</nav>
</header>

<main class="home-shell">

  <!-- üîç Search Bar -->
  <div class="home-row search-bar">
    <input id="productSearch" type="text" placeholder="Search categories..." aria-label="Search">
    <button type="button" aria-label="Search">üîç</button>
  </div>

  <!-- üß≠ Tabs -->
  <div class="home-row tabs">
    <a href="#" class="tab-link active" data-tab="shop">Shop</a>
    <a href="#" class="tab-link" data-tab="categories">Categories</a>
  </div>

  <!-- üè™ SHOP VIEW -->
  <section id="shop-view" class="tab-view active-view">
    <!-- Category chips -->
    <div class="home-row cat-filter" role="tablist" aria-label="Filter by category">
  <button class="chip active" data-cat="all">All</button>
  <button class="chip" data-cat="clothing">Clothing</button>
  <button class="chip" data-cat="electronics">Electronics</button>
  <button class="chip" data-cat="food">Food</button>
  <button class="chip" data-cat="accessories">Accessories</button>
</div>

    <!-- Latest Products -->
    <section class="home-row product-section">
      <div class="section-head">
        <h3>üõí Latest Products</h3>
        <a href="#" class="view-all">View all</a>
      </div>

      <div class="product-grid">
        {% for product in products %}
        <article class="product-card" data-cat="{{ product.category|lower }}">
          <div class="thumb">
            {% if product.image %}
              <img src="{{ product.image.url }}" alt="{{ product.title }}">
            {% else %}
              <img src="{% static 'images/noimage.png' %}" alt="No image available">
            {% endif %}
          </div>
          <div class="meta">
            <p class="title">{{ product.title }}</p>
            <p class="price">‚Ç±{{ product.price }}</p>
          </div>
        </article>
        {% empty %}
        <p>No products yet.</p>
        {% endfor %}
      </div>
    </section>

    <!-- Banner -->
    <div class="home-row promo-banner">
      <img src="{% static 'images/promobanner.png' %}" alt="Promo Banner">
    </div>

    <!-- Buttons -->
    <div class="home-row buttons">
      <a href="{% url 'product_list' %}" class="btn btn-primary">Upload Product</a>
    </div>
  </section>

  <!-- üìÇ CATEGORIES VIEW -->
  <section id="categories-view" class="tab-view">
    <div class="home-row">
      {% regroup products by category as category_list %}
      {% for group in category_list %}
      <div class="category-block">
        <div class="category-title">
          <h3>üìÇ {{ group.grouper }}</h3>
        </div>

        <div class="category-slider-wrapper">
          <button class="side-btn prev" aria-label="Previous">&#10094;</button>

          <div class="category-slider">
            {% for product in group.list %}
            <article class="product-card small">
              <div class="thumb">
                {% if product.image %}
                  <img src="{{ product.image.url }}" alt="{{ product.title }}">
                {% else %}
                  <img src="{% static 'images/noimage.png' %}" alt="No image available">
                {% endif %}
              </div>
              <div class="meta">
                <p class="title">{{ product.title }}</p>
                <p class="price">‚Ç±{{ product.price }}</p>
              </div>
            </article>
            {% endfor %}
          </div>

          <button class="side-btn next" aria-label="Next">&#10095;</button>
        </div>
      </div>
      {% endfor %}
    </div>
  </section>

</main>

<!-- ‚öôÔ∏è JS: Tabs + Slider -->
<script>
  // Tab Switching
  const tabLinks = document.querySelectorAll(".tab-link");
  const tabViews = document.querySelectorAll(".tab-view");

  tabLinks.forEach(link => {
    link.addEventListener("click", e => {
      e.preventDefault();

      tabLinks.forEach(l => l.classList.remove("active"));
      tabViews.forEach(v => v.classList.remove("active-view"));

      link.classList.add("active");
      document.getElementById(`${link.dataset.tab}-view`).classList.add("active-view");
    });
  });

  // Category Sliders
  document.querySelectorAll(".category-block").forEach(block => {
    const slider = block.querySelector(".category-slider");
    const prev = block.querySelector(".side-btn.prev");
    const next = block.querySelector(".side-btn.next");

    prev.addEventListener("click", () => {
      slider.scrollBy({ left: -300, behavior: "smooth" });
    });

    next.addEventListener("click", () => {
      slider.scrollBy({ left: 300, behavior: "smooth" });
    });
  });
</script>

{% endblock %}
